<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>StreamSuites Â· Login Successful</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/layout.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/overrides.css" />
  <link rel="stylesheet" href="../css/theme-dark.css" />
  <link rel="stylesheet" href="../css/updates.css" />

  <style>
    body {
      background: #0b0b0b;
      color: #eaeaea;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    .card {
      text-align: center;
      max-width: 420px;
      padding: 32px;
      border-radius: 10px;
      background: #151515;
      box-shadow: 0 0 40px rgba(0,0,0,0.6);
    }
    h1 {
      margin-bottom: 12px;
      font-size: 1.6rem;
    }
    p {
      opacity: 0.85;
      line-height: 1.4;
    }
    .error {
      color: #ff8a80;
      margin-top: 16px;
    }
    .error-link {
      color: #ffb5b5;
      display: inline-block;
      margin-top: 8px;
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>Login successful</h1>
    <p>
      Your StreamSuites creator session has been established.<br />
      <span data-auth-status>Finalizing your session...</span>
    </p>
    <p class="error" data-auth-error hidden>
      <span data-auth-error-message></span>
      <a class="error-link" href="/auth/login.html">Return to login</a>
    </p>
  </div>
  <script>
    (() => {
      "use strict";

      const RUNTIME_BASE_URL = "https://api.streamsuites.app";
      const SESSION_URL = `${RUNTIME_BASE_URL}/auth/session`;
      const CREATOR_HOME_URL = "https://creator.streamsuites.app/";
      const statusEl = document.querySelector("[data-auth-status]");
      const errorEl = document.querySelector("[data-auth-error]");
      const errorMessageEl = document.querySelector("[data-auth-error-message]");

      function setStatus(message) {
        if (statusEl) {
          statusEl.textContent = message;
        }
      }

      function showError(message) {
        if (!errorEl) return;
        if (errorMessageEl) {
          errorMessageEl.textContent = message;
        } else {
          errorEl.textContent = message;
        }
        errorEl.hidden = false;
      }

      function normalizeReason(value) {
        if (typeof value !== "string") return "";
        const trimmed = value.trim().toLowerCase();
        if (!trimmed) return "";
        if (trimmed.includes("cookie_missing")) return "cookie_missing";
        return trimmed;
      }

      function resolveReason(payload, response) {
        if (payload && typeof payload === "object") {
          const candidate =
            payload.reason ||
            payload.error?.reason ||
            payload.status ||
            payload.error ||
            payload.message;
          const normalized = normalizeReason(candidate);
          if (normalized) return normalized;
        }
        const headerReason =
          response?.headers &&
          ["x-auth-reason", "x-streamsuites-auth-reason", "x-auth-status"]
            .map((header) => response.headers.get(header))
            .find(Boolean);
        return normalizeReason(headerReason);
      }

      function resolveReasonEnum(payload, response) {
        if (payload && typeof payload === "object") {
          const candidate = payload.reason_enum || payload.error?.reason_enum;
          if (typeof candidate === "string" && candidate.trim()) {
            return candidate.trim().toUpperCase();
          }
        }
        const headerReasonEnum =
          response?.headers &&
          ["x-auth-reason-enum", "x-streamsuites-auth-reason-enum"]
            .map((header) => response.headers.get(header))
            .find(Boolean);
        if (typeof headerReasonEnum === "string" && headerReasonEnum.trim()) {
          return headerReasonEnum.trim().toUpperCase();
        }
        return "";
      }

      function isCookieMissing(response, payload) {
        if (!response || response.status !== 401) return false;
        const reasonEnum = resolveReasonEnum(payload, response);
        if (reasonEnum === "COOKIE_MISSING") return true;
        return resolveReason(payload, response) === "cookie_missing";
      }

      async function finalizeAuth() {
        setStatus("Confirming your session...");

        console.log("[Creator][Auth] Session confirmation request sent");
        let response;
        try {
          response = await fetch(SESSION_URL, { credentials: "include" });
        } catch (err) {
          console.log("[Creator][Auth] Session error", err);
          showError("We could not confirm your session. Please try again.");
          return;
        }

        console.log(`[Creator][Auth] Session status: ${response.status}`);

        let payload = null;
        try {
          payload = await response.json();
        } catch (err) {
          payload = null;
        }

        const isSessionValid =
          response.ok === true &&
          (payload?.ok === true ||
            payload?.authenticated === true ||
            payload?.session_valid === true);
        console.log(`[Creator][Auth] Session ok: ${isSessionValid ? "ok" : "error"}`);

        if (isCookieMissing(response, payload)) {
          window.location.replace("/auth/login.html");
          return;
        }

        if (!isSessionValid || response.status === 401) {
          showError("We could not confirm your session. Please return to login.");
          return;
        }

        setStatus("Session confirmed. Redirecting...");
        window.location.replace(CREATOR_HOME_URL);
      }

      document.addEventListener("DOMContentLoaded", finalizeAuth);
    })();
  </script>
</body>
</html>

